<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Drive - AI Dungeon Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b; /* bg-slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* bg-slate-400 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; /* bg-slate-600 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* bg-slate-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #334155; /* bg-slate-700 */
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        .roll-max {
            color: #16a34a; /* Bright Green */
            font-weight: bold;
            animation: pulse-green 1s;
        }
        .roll-min {
            color: #dc2626; /* Dark Red */
            font-weight: bold;
            animation: pulse-red 1s;
        }
        @keyframes pulse-green {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 10px 10px rgba(22, 163, 74, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 10px 10px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .ability-group .ability-item:not(:last-child) {
            border-bottom: 1px solid;
            @apply border-gray-200 dark:border-gray-700;
        }
        #chat-thinking-indicator {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="app" class="flex h-screen w-full">
        <!-- Sidebar Navigation -->
        <nav class="w-20 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col items-center py-4 shadow-md">
            <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-500 mb-8">AD</div>
            <div class="flex flex-col items-center space-y-6">
                <button onclick="app.switchView('chat')" class="nav-button w-14 h-14 flex items-center justify-center rounded-lg" data-view="chat" title="Chat">
                    <i class="fas fa-comments fa-fw text-xl"></i>
                </button>
                <button onclick="app.switchView('profile')" class="nav-button w-14 h-14 flex items-center justify-center rounded-lg" data-view="profile" title="User Profile">
                    <i class="fas fa-user-circle fa-fw text-xl"></i>
                </button>
                <button onclick="app.switchView('agents')" class="nav-button w-14 h-14 flex items-center justify-center rounded-lg" data-view="agents" title="Agents">
                    <i class="fas fa-users-cog fa-fw text-xl"></i>
                </button>
                <button onclick="app.switchView('settings')" class="nav-button w-14 h-14 flex items-center justify-center rounded-lg" data-view="settings" title="Settings">
                    <i class="fas fa-cog fa-fw text-xl"></i>
                </button>
            </div>
            <div class="mt-auto flex flex-col items-center space-y-4">
                 <button onclick="app.exportSession()" class="w-14 h-14 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" title="Export Session">
                    <i class="fas fa-file-export fa-fw text-lg"></i>
                </button>
                <button onclick="document.getElementById('import-session-input').click()" class="w-14 h-14 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" title="Import Session">
                    <i class="fas fa-file-import fa-fw text-lg"></i>
                </button>
                <input type="file" id="import-session-input" class="hidden" accept=".json" onchange="app.importSession(event)">
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-100 dark:bg-gray-800/50">
            <!-- Chat View -->
            <div id="chat-view" class="view flex-1 flex flex-col p-4">
                <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 pr-2">
                    <!-- Messages will be injected here -->
                </div>
                <div id="chat-thinking-indicator" class="hidden h-8 flex items-center justify-center gap-1.5">
                    <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
                    <div class="w-2 h-2 bg-indigo-500 rounded-full" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-indigo-500 rounded-full" style="animation-delay: 0.2s;"></div>
                </div>
                <div class="mt-4 flex items-center gap-4">
                    <input id="chat-input" type="text" class="flex-1 p-3 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Send a message...">
                    <button id="send-button" onclick="app.sendMessage()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Send</button>
                </div>
            </div>

            <!-- User Profile View -->
            <div id="profile-view" class="view hidden flex-1 overflow-y-auto p-6">
                <h1 class="text-3xl font-bold mb-6">User Profile</h1>
                <div class="flex justify-end gap-2 mb-4">
                    <button onclick="app.exportProfile()" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">Export Profile</button>
                    <button onclick="document.getElementById('import-profile-input').click()" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">Import Profile</button>
                    <input type="file" id="import-profile-input" class="hidden" accept=".json" onchange="app.importProfile(event)">
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Free-form Notes -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Notes</h2>
                        <div class="space-y-4 mb-4">
                            <input id="note-title" type="text" placeholder="Note Title (optional)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                            <input id="note-tags" type="text" placeholder="Tags (comma-separated)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                            <textarea id="note-content" placeholder="Your note here..." rows="4" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></textarea>
                            <button onclick="app.saveNote()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Save Note</button>
                        </div>
                        <div id="notes-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <!-- Saved notes will be listed here -->
                        </div>
                    </div>
                    <!-- Character Sheet -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Character Sheet</h2>
                        <div id="character-sheet-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                            <!-- Character Sheet fields will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agents View -->
            <div id="agents-view" class="view hidden flex-1 flex flex-col p-6">
                 <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold mb-2">Agents</h1>
                    <button onclick="app.addNewAgent()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-plus"></i> New Agent
                    </button>
                 </div>
                 <div class="my-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold mb-3">Aggregate Token Statistics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <h3 class="font-bold text-gray-600 dark:text-gray-400 mb-2">Active Agents Total</h3>
                            <div id="active-agents-stats" class="grid grid-cols-2 gap-x-4 gap-y-1"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-600 dark:text-gray-400 mb-2">Session Lifetime Total</h3>
                            <div id="session-total-stats" class="grid grid-cols-2 gap-x-4 gap-y-1"></div>
                        </div>
                    </div>
                 </div>
                 <div class="flex-1 overflow-y-auto pr-2">
                    <div id="agents-list" class="space-y-4">
                        <!-- Agent cards will be injected here -->
                    </div>
                 </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view hidden flex-1 overflow-y-auto p-6">
                <h1 class="text-3xl font-bold mb-6">Settings</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cosmetic Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Cosmetic</h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label for="dark-mode-toggle" class="font-medium text-gray-900 dark:text-gray-100">Dark Mode</label>
                                <button id="dark-mode-toggle" onclick="app.toggleDarkMode()" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600">
                                    <span id="dark-mode-switch" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="text-size-input" class="font-medium text-gray-900 dark:text-gray-100">Text Size (px)</label>
                                <input id="text-size-input" type="number" min="12" max="20" value="16" oninput="app.updateTextSize(this.value)" class="w-20 p-2 text-center rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                            </div>
                        </div>
                    </div>
                    <!-- AI Settings -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold mb-4">AI Configuration</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="ai-temp" class="block font-medium text-sm text-gray-700 dark:text-gray-300 mb-1">Temperature</label>
                                <input id="ai-temp" type="range" min="0" max="2" step="0.1" value="0.7" class="w-full">
                                <div class="text-xs text-gray-500 dark:text-gray-400 text-right">0.7</div>
                            </div>
                            <div>
                                <label for="ai-max-output" class="block font-medium text-sm text-gray-700 dark:text-gray-300 mb-1">Max Output Tokens</label>
                                <input id="ai-max-output" type="number" value="2048" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                            </div>
                             <div>
                                <label for="ai-price-limit" class="block font-medium text-sm text-gray-700 dark:text-gray-300 mb-1">Price Limit ($)</label>
                                <input id="ai-price-limit" type="number" value="5.00" step="0.01" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dice Roller -->
            <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 flex items-center justify-center gap-2 shadow-inner">
                <div class="flex items-center gap-2">
                    <input id="dice-count" type="number" value="1" min="1" class="w-16 p-2 text-center rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                    <span class="text-gray-500 dark:text-gray-400">d</span>
                    <select id="dice-type" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                        <option>4</option>
                        <option>6</option>
                        <option>8</option>
                        <option>10</option>
                        <option>12</option>
                        <option selected>20</option>
                        <option>100</option>
                    </select>
                    <button onclick="app.rollDice()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Roll</button>
                </div>
                <div id="dice-result" class="text-lg font-bold text-gray-900 dark:text-gray-100 ml-4 min-w-[150px] text-center"></div>
            </div>
        </main>
        
        <!-- Agent Edit Modal -->
        <div id="agent-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div id="agent-edit-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                <!-- Content will be injected here -->
            </div>
        </div>

        <!-- Ability Add/Edit Modal -->
        <div id="ability-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div id="ability-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                 <!-- Ability form will be injected here -->
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6">
                <h3 id="confirm-modal-title" class="text-lg font-bold mb-4">Are you sure?</h3>
                <p id="confirm-modal-text" class="text-sm text-gray-600 dark:text-gray-400 mb-6">This action cannot be undone.</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-cancel" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Cancel</button>
                    <button id="confirm-modal-confirm" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

<script>
// ===================================================================================
// --- BACKEND INTEGRATION: API Service Layer ---
// This object centralizes all communication with the backend.
// Replace the mock implementations with actual `fetch` calls to your API endpoints.
// ===================================================================================
const apiService = {
    /**
     * Loads the entire session state from the backend.
     * @returns {Promise<object|null>} A promise that resolves with the full application state object, or null if no session exists.
     */
    async loadSession() {
        console.log("BACKEND CALL (MOCK): Loading session...");
        // ** REAL IMPLEMENTATION: **
        // const response = await fetch('/api/session');
        // if (response.ok) {
        //     return await response.json();
        // }
        // return null;

        // ** MOCK IMPLEMENTATION: **
        // For now, we return null to allow the app to create a default new session.
        // To test loading, you can return a mock state object here.
        return null; 
    },

    /**
     * Sends the current context to the backend LLM and gets a response.
     * @param {object} payload - The data to send to the LLM.
     * @param {Array} payload.chatHistory - The full chat history.
     * @param {Array} payload.agents - All agent configurations.
     * @param {object} payload.userProfile - The user's profile data.
     * @param {object} payload.settings - The current AI settings (temp, etc.).
     * @returns {Promise<object>} A promise that resolves with the AI's response.
     * The response should include the new message and any updated agent stats.
     */
    async getLlmResponse(payload) {
        console.log("BACKEND CALL (MOCK): Getting LLM response for payload:", payload);
        // ** REAL IMPLEMENTATION: **
        // const response = await fetch('/api/llm/chat', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(payload)
        // });
        // return await response.json();

        // ** MOCK IMPLEMENTATION: **
        return new Promise(resolve => {
            setTimeout(() => {
                const activeAgents = payload.agents.filter(a => a.active && !a.isDM);
                const respondingAgent = activeAgents.length > 0 
                    ? activeAgents[Math.floor(Math.random() * activeAgents.length)] 
                    : payload.agents.find(a => a.isDM);
                
                const tokensUsed = 50 + Math.floor(Math.random() * 100);
                const price = (tokensUsed / 1000) * 0.0015;

                resolve({
                    newMessage: {
                        sender: respondingAgent.name,
                        text: `This is a simulated response from ${respondingAgent.name}. The backend processed your message.`
                    },
                    updatedAgentId: respondingAgent.id,
                    usageStats: {
                        tokensUsed,
                        price
                    }
                });
            }, 1500); // Simulate network delay
        });
    },

    /**
     * Saves a single object (like an agent or note) to the backend.
     * This is an example of a more granular save operation.
     * @param {string} type - The type of data being saved (e.g., 'agent', 'note').
     * @param {object} data - The data object to save.
     * @returns {Promise<object>} A promise that resolves with the saved data, possibly including a backend-generated ID.
     */
    async saveData(type, data) {
        console.log(`BACKEND CALL (MOCK): Saving ${type}`, data);
        // ** REAL IMPLEMENTATION: **
        // const response = await fetch(`/api/${type}`, {
        //     method: data.id ? 'PUT' : 'POST', // PUT to update, POST to create
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(data)
        // });
        // return await response.json();

        // ** MOCK IMPLEMENTATION: **
        // Return the same data, adding a mock ID if it's new.
        if (!data.id) {
            data.id = `${type}-${Date.now()}`;
        }
        return data;
    },

    /**
     * Deletes a single object from the backend.
     * @param {string} type - The type of data being deleted (e.g., 'agent', 'note').
     * @param {string} id - The ID of the object to delete.
     * @returns {Promise<void>}
     */
    async deleteData(type, id) {
        console.log(`BACKEND CALL (MOCK): Deleting ${type} with id ${id}`);
        // ** REAL IMPLEMENTATION: **
        // await fetch(`/api/${type}/${id}`, { method: 'DELETE' });
        
        // ** MOCK IMPLEMENTATION: **
        return Promise.resolve();
    },
    
    /**
     * Saves a settings object.
     * @param {object} settings - The settings object.
     * @returns {Promise<void>}
     */
     async saveSettings(settings) {
        console.log("BACKEND CALL (MOCK): Saving settings", settings);
        // ** REAL IMPLEMENTATION: **
        // await fetch('/api/settings', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify(settings)
        // });
     }
};


// ===================================================================================
// --- FRONTEND APPLICATION LOGIC ---
// ===================================================================================
const app = {
    // --- STATE MANAGEMENT ---
    state: {}, // State will be loaded from backend or defaults

    // --- INITIALIZATION ---
    async init() {
        console.log("Initializing Agent Drive UI...");
        
        // BUG FIX: Define templates BEFORE initializing state that depends on them.
        this.characterSheetTemplate = this.getCharacterSheetTemplate();
        this.statblockTemplate = this.getStatblockTemplate();
        this.dndData = this.getDndData();
        
        // --- BACKEND INTEGRATION ---
        // Attempt to load the session from the backend first.
        let loadedState = await apiService.loadSession();
        
        if (loadedState) {
            this.state = loadedState;
            console.log("Session loaded from backend.");
        } else {
            console.log("No session found on backend, creating new default session.");
            this.state = this.getDefaultState();
        }

        this.switchView('chat');
        this.render();
        this.addEventListeners();
    },
    
    getDefaultState() {
        const defaultState = {
            currentView: 'chat',
            darkMode: false,
            settings: {
                textSize: 16,
                ai: { temperature: 0.7, maxOutput: 2048, priceLimit: 5.00 }
            },
            chatHistory: [{
                sender: 'DM',
                text: 'Welcome to Agent Drive. The adventure awaits! What would you like to do first?'
            }],
            userProfile: { notes: [], characterSheet: {} },
            agents: [],
            sessionStats: { totalTokens: 0, requestCount: 0, totalPrice: 0 },
            lastScrollPosition: 0,
            lastModalScrollPosition: 0,
        };
        
        // Create default agents
        const dmAgent = this.createAgentObject({
            id: 'agent-dm', name: 'Dungeon Master', active: true, isDM: true,
            systemPrompt: 'You are a master storyteller and D&D dungeon master...'
        });
        const companionAgent = this.createAgentObject({
            id: 'agent-companion-1', name: 'Elara, the Rogue', active: true,
            systemPrompt: 'You are Elara, a witty and nimble rogue...'
        });
        defaultState.agents.push(dmAgent, companionAgent);
        
        // Create empty character sheet
        defaultState.userProfile.characterSheet = this.createEmptySheet(this.getCharacterSheetTemplate());
        
        return defaultState;
    },
    
    addEventListeners() {
        document.getElementById('ai-temp').addEventListener('input', (e) => {
            e.target.nextElementSibling.textContent = e.target.value;
            this.state.settings.ai.temperature = parseFloat(e.target.value);
            apiService.saveSettings(this.state.settings); // --- BACKEND INTEGRATION ---
        });
        document.getElementById('ai-max-output').addEventListener('input', (e) => {
            this.state.settings.ai.maxOutput = parseInt(e.target.value)
            apiService.saveSettings(this.state.settings); // --- BACKEND INTEGRATION ---
        });
        document.getElementById('ai-price-limit').addEventListener('input', (e) => {
            this.state.settings.ai.priceLimit = parseFloat(e.target.value)
            apiService.saveSettings(this.state.settings); // --- BACKEND INTEGRATION ---
        });
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });
    },

    // --- RENDERING ---
    render() {
        this.renderChat();
        this.renderProfile();
        this.renderAgents();
        this.renderSettings();
        this.updateActiveNav();
    },

    renderChat() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = this.state.chatHistory.map(msg => `
            <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-xl p-3 rounded-lg ${msg.sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100'}">
                    ${msg.sender !== 'user' ? `<div class="font-bold text-sm mb-1">${msg.sender}</div>` : ''}
                    <p>${msg.text}</p>
                </div>
            </div>
        `).join('');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    },
    
    renderProfile() {
        const notesList = document.getElementById('notes-list');
        notesList.innerHTML = this.state.userProfile.notes.map((note) => `
            <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold">${note.title || 'Untitled Note'}</h4>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${(note.tags || []).map(t => `<span class="bg-gray-300 dark:bg-gray-600 px-2 py-0.5 rounded-full">${t}</span>`).join(' ')}</div>
                    </div>
                    <button onclick="app.deleteNote('${note.id}')" class="text-red-500 hover:text-red-700 text-sm p-1"><i class="fas fa-trash"></i></button>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">${note.content}</p>
            </div>
        `).join('');
        
        const formEl = document.getElementById('character-sheet-form');
        formEl.innerHTML = this.buildFormFromTemplate(this.characterSheetTemplate, this.state.userProfile.characterSheet, 'userProfile.characterSheet');
    },

    renderAgents() {
        const agentsList = document.getElementById('agents-list');
        agentsList.innerHTML = this.state.agents.map(agent => this.createAgentCard(agent)).join('');
        this.updateAggregateStats();

        const agentViewScroller = document.querySelector('#agents-view > .flex-1.overflow-y-auto');
        if (agentViewScroller && this.state.lastScrollPosition > 0) {
            agentViewScroller.scrollTop = this.state.lastScrollPosition;
            this.state.lastScrollPosition = 0; // Reset after applying
        }
    },
    
    renderSettings() {
        const toggleBtn = document.getElementById('dark-mode-toggle');
        const toggleSwitch = document.getElementById('dark-mode-switch');
        if (this.state.darkMode) {
            document.documentElement.classList.add('dark');
            toggleBtn.classList.remove('bg-gray-200');
            toggleBtn.classList.add('bg-indigo-600');
            toggleSwitch.classList.add('translate-x-5');
        } else {
            document.documentElement.classList.remove('dark');
            toggleBtn.classList.add('bg-gray-200');
            toggleBtn.classList.remove('bg-indigo-600');
            toggleSwitch.classList.remove('translate-x-5');
        }
        
        document.documentElement.style.fontSize = this.state.settings.textSize + 'px';
        document.getElementById('text-size-input').value = this.state.settings.textSize;
        document.getElementById('ai-temp').value = this.state.settings.ai.temperature;
        document.getElementById('ai-temp').nextElementSibling.textContent = this.state.settings.ai.temperature;
        document.getElementById('ai-max-output').value = this.state.settings.ai.maxOutput;
        document.getElementById('ai-price-limit').value = this.state.settings.ai.priceLimit;
    },

    // --- VIEW MANAGEMENT ---
    switchView(viewId) {
        this.state.currentView = viewId;
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`${viewId}-view`).classList.remove('hidden');
        this.updateActiveNav();
    },

    updateActiveNav() {
        document.querySelectorAll('.nav-button').forEach(btn => {
            if (btn.dataset.view === this.state.currentView) {
                btn.classList.add('bg-indigo-100', 'dark:bg-indigo-500/20', 'text-indigo-600', 'dark:text-indigo-400');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            } else {
                btn.classList.remove('bg-indigo-100', 'dark:bg-indigo-500/20', 'text-indigo-600', 'dark:text-indigo-400');
                btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }
        });
    },

    // --- CORE FUNCTIONALITY ---
    async sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        this.state.chatHistory.push({ sender: 'user', text });
        input.value = '';
        this.renderChat();
        
        // Show thinking indicator and disable send button
        document.getElementById('chat-thinking-indicator').classList.remove('hidden');
        document.getElementById('send-button').disabled = true;

        // --- BACKEND INTEGRATION ---
        // Call the backend to get the LLM response.
        const payload = {
            chatHistory: this.state.chatHistory,
            agents: this.state.agents,
            userProfile: this.state.userProfile,
            settings: this.state.settings.ai
        };
        const response = await apiService.getLlmResponse(payload);
        
        // Update state with the response from the backend
        this.state.chatHistory.push(response.newMessage);
        
        const agentToUpdate = this.state.agents.find(a => a.id === response.updatedAgentId);
        if (agentToUpdate) {
            agentToUpdate.stats.totalTokens += response.usageStats.tokensUsed;
            agentToUpdate.stats.requestCount++;
            agentToUpdate.stats.totalPrice += response.usageStats.price;
        }
        this.state.sessionStats.totalTokens += response.usageStats.tokensUsed;
        this.state.sessionStats.requestCount++;
        this.state.sessionStats.totalPrice += response.usageStats.price;

        // Hide thinking indicator and re-enable send button
        document.getElementById('chat-thinking-indicator').classList.add('hidden');
        document.getElementById('send-button').disabled = false;
        
        this.render(); // Re-render everything to show new message and updated stats
    },

    rollDice() {
        const count = parseInt(document.getElementById('dice-count').value);
        const type = parseInt(document.getElementById('dice-type').value);
        const resultEl = document.getElementById('dice-result');
        
        let rolls = [];
        let total = 0;
        for (let i = 0; i < count; i++) {
            const roll = Math.floor(Math.random() * type) + 1;
            rolls.push(roll);
            total += roll;
        }

        const rollsHtml = rolls.map(r => {
            let className = '';
            if (r === type) className = 'roll-max';
            if (r === 1) className = 'roll-min';
            return `<span class="${className}">${r}</span>`;
        }).join(' + ');

        if (count > 1) {
            resultEl.innerHTML = `${rollsHtml} = <strong class="ml-2">${total}</strong>`;
        } else {
            resultEl.innerHTML = rollsHtml;
        }

        const chatText = `Rolled ${count}d${type}: ${resultEl.textContent}`;
        this.state.chatHistory.push({ sender: 'System', text: chatText });
        this.renderChat();
    },

    // --- SETTINGS ---
    toggleDarkMode() {
        this.state.darkMode = !this.state.darkMode;
        this.renderSettings();
        apiService.saveSettings(this.state.settings); // --- BACKEND INTEGRATION ---
    },

    updateTextSize(value) {
        const size = Math.max(12, Math.min(20, parseInt(value) || 16));
        this.state.settings.textSize = size;
        document.documentElement.style.fontSize = size + 'px';
        document.getElementById('text-size-input').value = size;
        apiService.saveSettings(this.state.settings); // --- BACKEND INTEGRATION ---
    },

    // --- USER PROFILE ---
    async saveNote() {
        const title = document.getElementById('note-title').value.trim();
        const tags = document.getElementById('note-tags').value.trim().split(',').map(t => t.trim()).filter(t => t);
        const content = document.getElementById('note-content').value.trim();
        if (!content) { alert('Note content cannot be empty.'); return; }

        const newNote = { title, tags, content };
        
        // --- BACKEND INTEGRATION ---
        const savedNote = await apiService.saveData('note', newNote);
        
        this.state.userProfile.notes.push(savedNote);
        
        document.getElementById('note-title').value = '';
        document.getElementById('note-tags').value = '';
        document.getElementById('note-content').value = '';

        this.renderProfile();
    },

    async deleteNote(noteId) {
        app.showConfirmModal('Delete Note?', 'Are you sure you want to delete this note?', async () => {
            // --- BACKEND INTEGRATION ---
            await apiService.deleteData('note', noteId);
            
            this.state.userProfile.notes = this.state.userProfile.notes.filter(n => n.id !== noteId);
            this.renderProfile();
        });
    },

    // --- AGENTS ---
    createAgentObject(options = {}) {
        const newStatblock = this.createEmptySheet(this.getStatblockTemplate());
        // Ensure all ability arrays are initialized to prevent errors
        newStatblock.special_traits = [];
        newStatblock.actions = [];
        newStatblock.bonus_actions = [];
        newStatblock.reactions = [];
        newStatblock.lair_actions = [];
        newStatblock.legendary_actions = { uses: 0, actions: [] };
        newStatblock.mythic_actions = { trigger: '', actions: [] };
        newStatblock.stats.damage_vulnerabilities = [];
        newStatblock.stats.damage_resistances = [];
        newStatblock.stats.damage_immunities = [];
        newStatblock.stats.condition_immunities = [];


        return {
            id: options.id || null, // ID will be set by backend on creation
            name: options.name || 'New Agent',
            active: options.active !== undefined ? options.active : true,
            isDM: options.isDM || false,
            context: {
                notes: [],
                sheetMode: 'statblock',
                characterSheet: this.createEmptySheet(this.getCharacterSheetTemplate()),
                statblock: newStatblock,
            },
            systemPrompt: options.systemPrompt || '',
            stats: { totalTokens: 0, requestCount: 0, totalPrice: 0.00 },
            ...options
        };
    },

    async addNewAgent() {
        const newAgent = this.createAgentObject();
        
        // --- BACKEND INTEGRATION ---
        const savedAgent = await apiService.saveData('agent', newAgent);
        
        this.state.agents.push(savedAgent);
        this.renderAgents();
        this.editAgent(savedAgent.id);
    },

    createAgentCard(agent) {
        const avgTokens = agent.stats.requestCount > 0 ? (agent.stats.totalTokens / agent.stats.requestCount).toFixed(0) : 0;
        const avgPrice = agent.stats.requestCount > 0 ? (agent.stats.totalPrice / agent.stats.requestCount).toFixed(6) : '0.00';
        
        return `
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" ${agent.active ? 'checked' : ''} class="sr-only peer" onchange="app.toggleAgentActive('${agent.id}')" ${agent.isDM ? 'disabled' : ''}>
                      <div class="w-11 h-6 rounded-full peer transition-colors ${agent.active ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'} peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all ${agent.isDM ? 'opacity-50 cursor-not-allowed' : ''}"></div>
                    </label>
                    <h3 class="text-lg font-semibold">${agent.name} ${agent.isDM ? '(DM)' : ''}</h3>
                </div>
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                    <button onclick="app.editAgent('${agent.id}')" class="hover:text-indigo-500 p-2 rounded-md"><i class="fas fa-edit"></i></button>
                    <button onclick="app.exportAgent('${agent.id}')" class="hover:text-indigo-500 p-2 rounded-md"><i class="fas fa-download"></i></button>
                    <button onclick="document.getElementById('import-agent-input-${agent.id}').click()" class="hover:text-indigo-500 p-2 rounded-md"><i class="fas fa-upload"></i></button>
                    <input type="file" id="import-agent-input-${agent.id}" class="hidden" accept=".json" onchange="app.importAgent(event, '${agent.id}')">
                    ${!agent.isDM ? `<button onclick="app.confirmDeleteAgent('${agent.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-md"><i class="fas fa-trash"></i></button>` : ''}
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-600 dark:text-gray-400 grid grid-cols-2 md:grid-cols-4 gap-2">
                <div><strong>Tokens:</strong> ${agent.stats.totalTokens}</div>
                <div><strong>Requests:</strong> ${agent.stats.requestCount}</div>
                <div><strong>Avg Tokens/Req:</strong> ${avgTokens}</div>
                <div><strong>Total Price:</strong> $${agent.stats.totalPrice.toFixed(4)}</div>
            </div>
        </div>
        `;
    },
    
    toggleAgentActive(agentId) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (agent && !agent.isDM) {
            agent.active = !agent.active;
            this.renderAgents();
            apiService.saveData('agent', agent); // --- BACKEND INTEGRATION ---
        }
    },
    
    confirmDeleteAgent(agentId) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) return;
        app.showConfirmModal(`Delete ${agent.name}?`, 'Are you sure you want to delete this agent?', async () => {
            // --- BACKEND INTEGRATION ---
            await apiService.deleteData('agent', agentId);
            
            this.state.agents = this.state.agents.filter(a => a.id !== agentId);
            this.renderAgents();
        });
    },
    
    editAgent(agentId) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) return;

        const modal = document.getElementById('agent-edit-modal');
        const content = document.getElementById('agent-edit-content');
        
        const agentIndex = this.state.agents.findIndex(a => a.id === agentId);
        const characterSheetHTML = this.buildFormFromTemplate(this.characterSheetTemplate, agent.context.characterSheet, `agents[${agentIndex}]`);
        const statblockFormHTML = this.buildFormFromTemplate(this.statblockTemplate, agent.context.statblock, `agents[${agentIndex}]`);
        const statblockAbilitiesHTML = this.buildInteractiveAbilitiesSection(agentId);

        content.innerHTML = `
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold">Edit Agent: ${agent.name}</h2>
                <button onclick="app.closeAgentModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                             <h3 class="text-lg font-semibold">General</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400">Agent Name</label>
                                <input type="text" value="${agent.name}" oninput="app.updateAgentField('${agent.id}', 'name', this.value)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600" ${agent.isDM ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400">System Prompt</label>
                                <textarea rows="6" oninput="app.updateAgentField('${agent.id}', 'systemPrompt', this.value)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">${agent.systemPrompt}</textarea>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400">Free-form Context</label>
                                <textarea rows="4" placeholder="Add free-form context for this agent..." oninput="app.updateAgentField('${agent.id}', 'context.freeform', this.value)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">${agent.context.freeform || ''}</textarea>
                            </div>
                        </div>
                        <div class="space-y-4">
                             <h3 class="text-lg font-semibold">Data Mode</h3>
                             <div>
                                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400">Fillable Sheet Mode</label>
                                <select onchange="app.updateAgentSheetMode('${agent.id}', this.value)" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                                    <option value="statblock" ${agent.context.sheetMode === 'statblock' ? 'selected' : ''}>Statblock</option>
                                    <option value="character" ${agent.context.sheetMode === 'character' ? 'selected' : ''}>Character Sheet</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="agent-sheet-container" class="mt-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-900/50">
                        ${agent.context.sheetMode === 'character' 
                            ? characterSheetHTML 
                            : statblockFormHTML + statblockAbilitiesHTML
                        }
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-100 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 text-right">
                <button onclick="app.closeAgentModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold">Done</button>
            </div>
        `;
        modal.classList.remove('hidden');

        // Restore scroll position after modal content is rendered
        setTimeout(() => {
            const modalScroller = document.querySelector('#agent-edit-modal .overflow-y-auto');
            if (modalScroller && this.state.lastModalScrollPosition > 0) {
                modalScroller.scrollTop = this.state.lastModalScrollPosition;
                this.state.lastModalScrollPosition = 0; // Reset
            }
        }, 0);
    },

    closeAgentModal() {
        const agentViewScroller = document.querySelector('#agents-view > .flex-1.overflow-y-auto');
        this.state.lastScrollPosition = agentViewScroller ? agentViewScroller.scrollTop : 0;

        document.getElementById('agent-edit-modal').classList.add('hidden');
        this.renderAgents(); 
    },

    updateAgentField(agentId, fieldPath, value) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) return;
        this.setNestedValue(`agents[${this.state.agents.indexOf(agent)}].${fieldPath}`, value);
        apiService.saveData('agent', agent); // --- BACKEND INTEGRATION ---
    },
    
    updateAgentSheetMode(agentId, mode) {
        const agent = this.state.agents.find(a => a.id === agentId);
        agent.context.sheetMode = mode;
        this.editAgent(agentId); // Re-render the modal content
        apiService.saveData('agent', agent); // --- BACKEND INTEGRATION ---
    },

    updateAggregateStats() {
        const activeAgents = this.state.agents.filter(a => a.active);
        const activeStats = { totalTokens: 0, requestCount: 0, totalPrice: 0 };
        activeAgents.forEach(a => {
            activeStats.totalTokens += a.stats.totalTokens;
            activeStats.requestCount += a.stats.requestCount;
            activeStats.totalPrice += a.stats.totalPrice;
        });

        document.getElementById('active-agents-stats').innerHTML = `
            <span><strong>Total Tokens:</strong> ${activeStats.totalTokens}</span>
            <span><strong>Total Requests:</strong> ${activeStats.requestCount}</span>
            <span><strong>Total Price:</strong> $${activeStats.totalPrice.toFixed(4)}</span>
        `;
        document.getElementById('session-total-stats').innerHTML = `
            <span><strong>Total Tokens:</strong> ${this.state.sessionStats.totalTokens}</span>
            <span><strong>Total Requests:</strong> ${this.state.sessionStats.requestCount}</span>
            <span><strong>Total Price:</strong> $${this.state.sessionStats.totalPrice.toFixed(4)}</span>
        `;
    },

    // --- IMPORT / EXPORT (Local Fallback) ---
    exportSession() {
        this.exportJson(this.state, `dnd-session-${new Date().toISOString()}.json`);
    },

    importSession(event) {
        this.importJson(event, (data) => {
            try {
                if (data.agents && data.chatHistory) {
                    this.state = data;
                    this.render();
                    alert('Local session imported successfully! Note: This does not save to the backend.');
                } else { throw new Error('Invalid session file format.'); }
            } catch (error) { alert('Error importing session: ' + error.message); }
        });
        event.target.value = '';
    },

    exportProfile() { this.exportJson(this.state.userProfile, 'user-profile.json'); },
    importProfile(event) { /* ... */ },
    exportAgent(agentId) { /* ... */ },
    importAgent(event, agentId) { /* ... */ },

    exportJson(data, filename) {
        const dataStr = JSON.stringify(data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', filename);
        linkElement.click();
    },

    importJson(event, callback) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                callback(data);
            } catch (error) { alert('Error parsing JSON file: ' + error.message); }
        };
        reader.readAsText(file);
        event.target.value = '';
    },
    
    // --- FORM & TEMPLATE HELPERS ---
    buildFormFromTemplate(template, data, basePath) {
        let html = '';
        for (const section of template) {
            html += `<fieldset class="border border-gray-200 dark:border-gray-700 p-3 rounded-lg mb-4"><legend class="px-2 font-semibold text-gray-600 dark:text-gray-400">${section.title}</legend>`;
            
            if (section.id === 'defenses') {
                 html += `<div class="relative grid grid-cols-1 md:grid-cols-2 gap-4">`;
                 html += `<div class="absolute -top-2 right-0"><i class="fas fa-question-circle text-gray-400" title="Select from the list or type a custom value and press Enter."></i></div>`;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-${section.columns || 2} gap-4">`;
            }

            for (const field of section.fields) {
                const agentId = basePath.startsWith('agents') ? this.state.agents[parseInt(basePath.match(/\[(\d+)\]/)[1])].id : null;
                const relativePath = basePath.includes('.') ? basePath.substring(basePath.indexOf('.') + 1) + '.' + field.id : field.id;
                const value = this.getNestedValue(data, field.id);
                html += '<div>';
                html += `<label class="block text-sm font-medium text-gray-600 dark:text-gray-400">${field.label}</label>`;
                const inputClasses = "w-full p-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600";
                switch(field.type) {
                    case 'number':
                        html += `<input type="number" value="${value || 0}" onchange="app.updateAgentField('${agentId}', '${relativePath}', this.value, true)" class="${inputClasses}">`;
                        break;
                    case 'text':
                        html += `<input type="text" value="${value || ''}" onchange="app.updateAgentField('${agentId}', '${relativePath}', this.value)" class="${inputClasses}">`;
                        break;
                    case 'tags':
                        html += this.buildTagInputUI(agentId, `context.statblock.${field.id}`, value || [], this.dndData[field.options]);
                        break;
                }
                html += '</div>';
            }
            html += '</div></fieldset>';
        }
        return html;
    },
    
    getNestedValue(obj, path) {
        return path.split('.').reduce((o, k) => (o && o[k] !== undefined) ? o[k] : null, obj);
    },

    setNestedValue(path, value, isNumber = false, baseObj = this.state) {
        const keys = path.split('.');
        let obj = baseObj;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!obj[keys[i]]) {
                obj[keys[i]] = {};
            }
            obj = obj[keys[i]];
        }
        obj[keys[keys.length - 1]] = isNumber ? parseFloat(value) || 0 : value;
    },
    
    createEmptySheet(template) {
        const sheet = {};
        template.forEach(section => {
            section.fields.forEach(field => {
                this.setNestedValue(field.id, field.type === 'tags' ? [] : (field.type === 'number' ? 0 : ''), false, sheet);
            });
        });
        return sheet;
    },

    // --- INTERACTIVE ABILITIES UI ---
    buildInteractiveAbilitiesSection(agentId) {
        const agent = this.state.agents.find(a => a.id === agentId);
        const statblock = agent.context.statblock;

        const simpleAbilityFields = [ { key: 'name', placeholder: 'Name', type: 'text' }, { key: 'description', placeholder: 'Description', type: 'textarea' }];
        const actionFields = [
            { key: 'name', placeholder: 'Action Name', type: 'text' }, { key: 'description', placeholder: 'Description', type: 'textarea' },
            { key: 'attack_bonus', placeholder: 'Atk Bonus', type: 'number', isAttackField: true }, { key: 'damage.formula', placeholder: 'Dmg Formula', type: 'text', isAttackField: true }, { key: 'damage.type', placeholder: 'Dmg Type', type: 'text', isAttackField: true },
        ];
        const legendaryActionFields = [
            { key: 'name', placeholder: 'Action Name', type: 'text' }, { key: 'cost', placeholder: 'Cost', type: 'number' }, { key: 'description', placeholder: 'Description', type: 'textarea' },
        ];

        return `
        <fieldset class="border border-gray-200 dark:border-gray-700 p-3 rounded-lg mt-4">
            <legend class="px-2 font-semibold text-gray-600 dark:text-gray-400">Abilities & Actions</legend>
            <div class="space-y-4">
                ${this.buildAbilityListUI(agentId, 'context.statblock.special_traits', 'Special Traits', statblock.special_traits, simpleAbilityFields)}
                ${this.buildAbilityListUI(agentId, 'context.statblock.actions', 'Actions', statblock.actions, actionFields)}
                ${this.buildAbilityListUI(agentId, 'context.statblock.bonus_actions', 'Bonus Actions', statblock.bonus_actions, actionFields)}
                ${this.buildAbilityListUI(agentId, 'context.statblock.reactions', 'Reactions', statblock.reactions, simpleAbilityFields)}
                ${this.buildAbilityListUI(agentId, 'context.statblock.lair_actions', 'Lair Actions', statblock.lair_actions, [{ key: 'description', placeholder: 'Description', type: 'textarea' }])}
                
                <div class="ability-group bg-white dark:bg-gray-800 p-3 rounded-lg">
                    <h4 class="font-semibold mb-2">Legendary Actions</h4>
                    <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Uses per round</label>
                    <input type="number" class="w-full p-2 rounded-md bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 mb-2" value="${statblock.legendary_actions.uses || 0}" oninput="app.updateAgentField('${agentId}', 'context.statblock.legendary_actions.uses', this.value, true)">
                    ${this.buildAbilityListUI(agentId, 'context.statblock.legendary_actions.actions', '', statblock.legendary_actions.actions, legendaryActionFields, false)}
                </div>

                <div class="ability-group bg-white dark:bg-gray-800 p-3 rounded-lg">
                    <h4 class="font-semibold mb-2">Mythic Actions</h4>
                    <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Trigger Condition</label>
                    <input type="text" class="w-full p-2 rounded-md bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 mb-2" placeholder="e.g., When reduced to 0 HP" value="${statblock.mythic_actions.trigger || ''}" oninput="app.updateAgentField('${agentId}', 'context.statblock.mythic_actions.trigger', this.value)">
                     ${this.buildAbilityListUI(agentId, 'context.statblock.mythic_actions.actions', '', statblock.mythic_actions.actions, simpleAbilityFields, false)}
                </div>
            </div>
        </fieldset>
        `;
    },

    buildAbilityListUI(agentId, path, title, abilities, fields, showTitle = true) {
        let itemsHtml = (abilities || []).map((item, index) => {
            let attackDetails = '';
            if (item.attack_bonus || (item.damage && item.damage.formula)) {
                attackDetails = `
                <div class="text-xs mt-1 pl-2 border-l-2 border-gray-300 dark:border-gray-600">
                    <strong>Atk:</strong> ${item.attack_bonus > 0 ? '+' : ''}${item.attack_bonus || 0}, 
                    <strong>Dmg:</strong> ${item.damage.formula || 'N/A'} (${item.damage.type || 'N/A'})
                </div>`;
            }

            return `
            <div class="ability-item p-2 bg-gray-50 dark:bg-gray-700/50 rounded-md">
                <div class="flex justify-between items-start">
                    <div class="flex-1 mr-2">
                        <p class="font-semibold">${item.name || `(${title.slice(0, -1)})`}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${item.description || ''}</p>
                        ${attackDetails}
                    </div>
                    <div class="flex items-center">
                        <button onclick="app.deleteAbility('${agentId}', '${path}', ${index})" class="text-red-500 hover:text-red-700 p-2 rounded-md"><i class="fas fa-trash-alt fa-fw"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');

        return `
        <div class="ability-group bg-white dark:bg-gray-800 p-3 rounded-lg">
            <div class="flex justify-between items-center mb-2">
                ${showTitle ? `<h4 class="font-semibold">${title}</h4>` : '<div></div>'}
                <button onclick="app.openAbilityModal('${agentId}', '${path}', '${title}', JSON.parse(atob('${btoa(JSON.stringify(fields))}')))" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-sm rounded-md"><i class="fas fa-plus fa-fw"></i> Add</button>
            </div>
            <div class="space-y-2">${itemsHtml || '<p class="text-xs text-center text-gray-400 dark:text-gray-500 py-2">No items added.</p>'}</div>
        </div>
        `;
    },
    
    openAbilityModal(agentId, path, title, fields) {
        const modal = document.getElementById('ability-modal');
        const content = document.getElementById('ability-modal-content');

        const formFieldsHtml = fields.map(field => `
            <div class="flex-1 min-w-full ${field.isAttackField ? 'atk-details-modal hidden' : ''}">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-400">${field.placeholder}</label>
                ${field.type === 'textarea'
                    ? `<textarea id="modal-${field.key.replace('.','-')}" class="w-full p-2 text-sm rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600" rows="3"></textarea>`
                    : `<input type="${field.type}" id="modal-${field.key.replace('.','-')}" class="w-full p-2 text-sm rounded-md bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">`
                }
            </div>
        `).join('');
        
        const hasAttackFields = fields.some(f => f.isAttackField);

        content.innerHTML = `
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold">Add ${title}</h3>
            </div>
            <div class="p-6 space-y-4 flex-1 overflow-y-auto">
                ${formFieldsHtml}
            </div>
            <div class="p-4 bg-gray-100 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
                ${hasAttackFields ? `<button onclick="document.querySelectorAll('.atk-details-modal').forEach(el => el.classList.toggle('hidden'))" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Toggle Attack Fields</button>` : '<div></div>'}
                <div>
                    <button onclick="document.getElementById('ability-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">Cancel</button>
                    <button onclick="app.addAbility('${agentId}', '${path}', JSON.parse(atob('${btoa(JSON.stringify(fields))}')))" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Save</button>
                </div>
            </div>
        `;
        modal.classList.remove('hidden');
    },

    addAbility(agentId, path, fields) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) { console.error("Agent not found for addAbility:", agentId); return; }

        let abilityArray = this.getNestedValue(agent, path);
        
        if (!Array.isArray(abilityArray)) {
            this.setNestedValue(path, [], false, agent);
            abilityArray = this.getNestedValue(agent, path);
        }

        const newAbility = {};
        fields.forEach(field => {
            const input = document.getElementById(`modal-${field.key.replace('.','-')}`);
            if (input) {
                const value = field.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                this.setNestedValue(field.key, value, field.type === 'number', newAbility);
            }
        });
        
        abilityArray.push(newAbility);
        
        document.getElementById('ability-modal').classList.add('hidden');
        this.refreshAgentModal(agentId);
        apiService.saveData('agent', agent);
    },

    deleteAbility(agentId, path, index) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) { console.error("Agent not found for deleteAbility:", agentId); return; }
        
        const abilityArray = this.getNestedValue(agent, path);
        if (Array.isArray(abilityArray)) {
            abilityArray.splice(index, 1);
            this.refreshAgentModal(agentId);
            apiService.saveData('agent', agent);
        }
    },
    
    refreshAgentModal(agentId) {
        const modalScroller = document.querySelector('#agent-edit-modal .overflow-y-auto');
        this.state.lastModalScrollPosition = modalScroller ? modalScroller.scrollTop : 0;
        this.editAgent(agentId);
    },

    // --- TAG INPUT UI ---
    buildTagInputUI(agentId, path, currentTags = [], options = []) {
        const dataListId = `datalist-${path.replace(/\./g, '-')}`;
        const tagsHtml = currentTags.map((tag, index) => `
            <span class="flex items-center bg-indigo-100 dark:bg-indigo-500/30 text-indigo-800 dark:text-indigo-300 text-sm font-medium px-2.5 py-0.5 rounded">
                ${tag}
                <button onclick="app.removeTag('${agentId}', '${path}', ${index})" class="ml-1.5 text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-200">&times;</button>
            </span>
        `).join('');

        const optionsHtml = options.map(opt => `<option value="${opt}"></option>`).join('');

        return `
            <div class="bg-white dark:bg-gray-700 p-1 rounded-md border border-gray-300 dark:border-gray-600">
                <div class="flex flex-wrap gap-1 p-1 min-h-[24px]">${tagsHtml}</div>
                <input list="${dataListId}" onkeydown="app.handleTagInput(event, '${agentId}', '${path}')" onchange="app.addTag('${agentId}', '${path}', this.value); this.value=''" class="w-full bg-transparent outline-none p-1 text-sm" placeholder="Select or type custom...">
                <datalist id="${dataListId}">${optionsHtml}</datalist>
            </div>
        `;
    },

    handleTagInput(event, agentId, path) {
        const input = event.target;
        const value = input.value.trim();
        
        if (event.key === 'Enter' && value) {
            event.preventDefault();
            this.addTag(agentId, path, value);
            input.value = '';
        }
    },

    addTag(agentId, path, value) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) return;

        let tags = this.getNestedValue(agent, path);
        if (!Array.isArray(tags)) {
            this.setNestedValue(path, [], false, agent);
            tags = this.getNestedValue(agent, path);
        }

        if (value && !tags.includes(value)) {
            tags.push(value);
            this.refreshAgentModal(agentId);
            apiService.saveData('agent', agent);
        }
    },

    removeTag(agentId, path, index) {
        const agent = this.state.agents.find(a => a.id === agentId);
        if (!agent) return;

        const tags = this.getNestedValue(agent, path) || [];
        tags.splice(index, 1);
        this.refreshAgentModal(agentId);
        apiService.saveData('agent', agent);
    },
    
    // --- MODALS ---
    showConfirmModal(title, text, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-text').textContent = text;
        
        const confirmBtn = document.getElementById('confirm-modal-confirm');
        const cancelBtn = document.getElementById('confirm-modal-cancel');

        const confirmHandler = () => {
            onConfirm();
            closeModal();
        };
        
        const closeHandler = () => {
            closeModal();
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', closeHandler);
        };

        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', closeHandler);

        modal.classList.remove('hidden');
    },

    // --- DATA TEMPLATES ---
    getDndData() {
        return {
            damageTypes: ["Slashing", "Piercing", "Bludgeoning", "Poison", "Acid", "Fire", "Cold", "Radiant", "Necrotic", "Lightning", "Thunder", "Force", "Psychic"],
            conditionTypes: ["Blinded", "Charmed", "Deafened", "Frightened", "Grappled", "Incapacitated", "Invisible", "Paralyzed", "Petrified", "Poisoned", "Prone", "Restrained", "Stunned", "Unconscious", "Exhaustion"]
        }
    },

    getCharacterSheetTemplate() { return [ /* ... (template unchanged) ... */ ] },
    getStatblockTemplate() {
        return [
            { title: "Meta", columns: 3, fields: [
                { id: 'name', label: 'Name', type: 'text' }, { id: 'meta.size', label: 'Size', type: 'text' }, { id: 'meta.type', label: 'Type', type: 'text' }, { id: 'meta.alignment', label: 'Alignment', type: 'text' },
            ]},
            { title: "Core Stats", columns: 3, fields: [
                { id: 'stats.armor_class.value', label: 'AC', type: 'number' }, { id: 'stats.hit_points.average', label: 'HP (Average)', type: 'number' }, { id: 'stats.hit_points.formula', label: 'HP (Formula)', type: 'text' }, { id: 'stats.speed.walk.value', label: 'Speed (Walk)', type: 'number' }, { id: 'stats.challenge.rating', label: 'CR', type: 'text' }, { id: 'stats.proficiency_bonus', label: 'Proficiency Bonus', type: 'number' },
            ]},
            { title: "Attributes", columns: 3, fields: [
                { id: 'attributes.strength.score', label: 'STR Score', type: 'number' }, { id: 'attributes.dexterity.score', label: 'DEX Score', type: 'number' }, { id: 'attributes.constitution.score', label: 'CON Score', type: 'number' }, { id: 'attributes.intelligence.score', label: 'INT Score', type: 'number' }, { id: 'attributes.wisdom.score', label: 'WIS Score', type: 'number' }, { id: 'attributes.charisma.score', label: 'CHA Score', type: 'number' },
            ]},
            { id: "defenses", title: "Defenses & Senses", columns: 2, fields: [
                { id: 'stats.damage_vulnerabilities', label: 'Damage Vulnerabilities', type: 'tags', options: 'damageTypes' },
                { id: 'stats.damage_resistances', label: 'Damage Resistances', type: 'tags', options: 'damageTypes' },
                { id: 'stats.damage_immunities', label: 'Damage Immunities', type: 'tags', options: 'damageTypes' },
                { id: 'stats.condition_immunities', label: 'Condition Immunities', type: 'tags', options: 'conditionTypes' },
                { id: 'stats.senses.passive_perception', label: 'Passive Perception', type: 'number' },
            ]}
        ];
    },
};

// Add templates back in before running
app.getCharacterSheetTemplate = function() {
    return [
        { title: "Core Stats", columns: 3, fields: [
            { id: 'name', label: 'Character Name', type: 'text' }, { id: 'class', label: 'Class & Level', type: 'text' }, { id: 'race', label: 'Race', type: 'text' }, { id: 'alignment', label: 'Alignment', type: 'text' }, { id: 'background', label: 'Background', type: 'text' }, { id: 'xp', label: 'Experience Points', type: 'number' },
        ]},
        { title: "Combat", columns: 3, fields: [
            { id: 'ac', label: 'Armor Class', type: 'number' }, { id: 'hp.current', label: 'Current HP', type: 'number' }, { id: 'hp.max', label: 'Max HP', type: 'number' }, { id: 'hp.temp', label: 'Temporary HP', type: 'number' }, { id: 'speed', label: 'Speed (ft)', type: 'number' }, { id: 'initiative', label: 'Initiative', type: 'number' }, { id: 'hit_dice', label: 'Hit Dice', type: 'text' }, { id: 'proficiency_bonus', label: 'Proficiency Bonus', type: 'number' },
        ]},
        { title: "Ability Scores", columns: 3, fields: [
            { id: 'attributes.strength', label: 'Strength', type: 'number' }, { id: 'attributes.dexterity', label: 'Dexterity', type: 'number' }, { id: 'attributes.constitution', label: 'Constitution', type: 'number' }, { id: 'attributes.intelligence', label: 'Intelligence', type: 'number' }, { id: 'attributes.wisdom', label: 'Wisdom', type: 'number' }, { id: 'attributes.charisma', label: 'Charisma', type: 'number' },
        ]},
        { title: "Skills & Saves", columns: 1, fields: [ { id: 'saving_throws', label: 'Saving Throws', type: 'textarea' }, { id: 'skills', label: 'Skills', type: 'textarea' }, ]},
        { title: "Features & Traits", columns: 1, fields: [ { id: 'features', label: 'Features & Traits', type: 'textarea' }, ]},
        { title: "Inventory", columns: 1, fields: [ { id: 'inventory', label: 'Equipment', type: 'textarea' }, ]},
        { title: "Spells", columns: 1, fields: [ { id: 'spells', label: 'Spells & Cantrips', type: 'textarea' }, ]}
    ];
};


// --- START THE APP ---
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

</script>

</body>
</html>
